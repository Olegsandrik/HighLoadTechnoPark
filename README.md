# HighLoadTechnoPark
Репозиторий работы по высоконагруженным системам Технопарка от ВК

# Тип сервиса
Онлайн кинотеатр, аналогом которого является Кинопоиск 
# MVP
1) Регистрация и авторизация пользователя.
Описание: Сервис будет предоставлять возможность регистрации и авторизации на сайте.
2) Поиск фильма или сериала в каталоге.
Описание: Поиск по описанию или по названию фильма/сериала.
3) Просмотр описания и комментариев видеоматериала.
Описание: Существует возможность до просмотра ознакомиться с контентом, а так же в случае покупки подписки можно прочитать комментарии профессиональных кинокритиков.
4) Просмотр видеоматериала.
Описание: Просмотр в 4k только для зрителей с платной подпиской и 1080p для остальных пользователей, с условием ограниченного доступа к видеоматериалам.
5) Выставление оценки видеоматериалу.
Описание: Для зарегистрированных пользователей существует возможность поставить оценку и написать комментарий после просмотра.
6) Подписка.
Описание: Подписка (1/6/12/24 месяцев) для просмотра в 4к, а также приобретение определенного видеоматериала.
# Целевая аудитория
Пользователями являются граждане России и СНГ возраста от 12 до 65 лет. Около 25 млн и 10 млн постоянных пользователей России и СНГ соответсвенно, а также около 3-4 млн и 2 млн пользователей ежедневно.


География сайта: [1] 

### Рисунок 1
![image](https://github.com/user-attachments/assets/ebf25d48-de9a-46a1-917a-e1b4e0fcae6f)

# Продуктовые метрики

| Месячная аудитория  | Дневная аудитория |
| ------------- | ------------- | 
| 22 млн [2] | 2.5 млн [2] |

# Уточнение
В сервисе для просмотра требуется


## Подсчет размера хранилища:
Из источника номер три следует, что всего 80 тысяч единиц контента. В среднем серия сериала 4k длительностью час весит 20 Гб, а полноценный фильм 4k длительностью 2,5 часа около 50 Гб следовательно 35 Гб в среднем для материала в разрешении 4к, а значит **3 петабайта для 4к** данных весит вся библиотека Кинопоиска. Однако на серверах будут храниться не только копии 4к, но и копии 1080р и 360р. Приблизительные коэффициенты уменьшения размера файла для различных разрешений: 1/4 от размера файла 4K для 1080р и 1/18 от размера файла 4K для 360р, таким образом получаются значения 7 Гб * 80000 = 560000 ГБ = 560 ТБ = **0,56 ПБ
для 1080р** и 1.75 Гб * 80000 = 140000 ГБ = 140 ТБ = **0,14 ПБ для 360р**. Соответственно **размер общего хранилища получается 3,7 Пб**. Некоторые тайтлы, выпущенные за долго до 2020-х и имеющие максимальное разрешение 360р, были искусственно улучшены нейросетями и доведены до качества 1080р или выше, что позволяет при вычислении объема хранилища пренебречь материалами, которые не изначально не имеют качетсво 1080 и выше.
Для того, чтобы хранить персональные данные пользователя нужно понимать, что он может включать текстовую информацию (имя, возраст, биография), а также фотографии. Текстовые данные занимают несколько килобайт, а фотографии могут варьироваться от 100 Кб до нескольких мегабайт. Так с верхней оценкой по этому параметру как 20 Мб, то **20 Мб** на пользователя в среднем.
Всего на храниение данных пользователя требуется выделить около **0,5 Тб**. 
Одна рецензия ограничена 2 тысячами символов, таким образом в ASCII одна рецензия весит не более 2 Кб, следовательно 2*827824 = 1655648 Кб = 1,6 Гб. Для запаса выделим **2 Гб** для того, чтобы там же хранить оценки от 1 до 10.
| Размер хранилища на человека | Размер хранилища на всех пользователей | Размер хранилища на весь видеоконтент | Размер хранилища на рецензии и оценок |
| ------------- | ------------- | ------------- | ------------- |
| 20 Мб | 0.5 Тб | 3,7 Пб | 2 Гб |


## Подсчет среднего количества действий пользователя по типам в день:

Регистрацию нет смысла считать, а авторизацию за день человек делает в среднем **1 раз**.
Покупает человек подписку раз в пару месяцев, значит **0.16 раз** в день. 
В 2023-м каждый подписчик в среднем увидел в онлайн-кинотеатре 34,5 тайтлов. Больше всего подписчики смотрели фильмы — в среднем по 22,6 фильма.) Таким образов в месяц это 2.9 тайтла (для простоты это будут фильмы [4] в месяц, значит 1/10 фильма в день или **16-18 минут**.
За 2023 год в среднем в месяц было 180 млн оценок [5], таким образом 6 млн оценок в день или **0.27 оценок** у одного пользователя в день.
Всего рецензий 827824, ежедневно публикуются сотни [6]. Таким образом пусть будет в среднем 400 рецензий в день, следовательно **0.000018** в день на человека.
Поиск контента пользователь использует около **3-4** раз в день.

## Таблица подсчетов
| Действие пользователя | Частота действий в день |
| ------------- | ------------- | 
| Регистрация и авторизация | 1 |
| Покупка подписки | 0.16 |
| Поиск видеоматериала | 4 |
| Оставление комментария | 0.000018 |
| Просмотр видеоматериала | 16-18 минут |
| Оценка видеоматериала | 0.27 |


# Технические метрики

## RPS в разбивке по типам запросов
| Действие  | Формула | RPS |
| ------------- | ------------- | ------------- |
| Регистрация и авторизация  | 1*2500000/86400  | 29  |
| Поиск фильма  | 4*2500000/86400  | 115 |
| Оставление комментария | 0.000018*2500000/86400 | 0.0005 |
| Просмотр видеоматериала  | (17*60)*2500000/84600 | 30141 |
| Платная подписка  | 0.16*2500000/86400 | 4.6 |
| Оценка видеоматериала | 0.27*2500000/86400 | 7.8 |

## Сетевой трафик:
Битрейт видео на КиноПоиске может варьироваться в зависимости от качества контента и конкретного фильма или сериала. Обычно для потокового видео в HD разрешении битрейт составляет от 3 до 5 Мбит/с, а для 4K — от 15 до 25 Мбит/с. Ввиду того, что с платной подпиской нашим сервисом пользуется только 50% пользователей, но при этом 80% из них потребляют контент либо с мобильного телефона, либо с ноутбука с разрешением 1080р, то целесообразно вычислить 10%-ный общий трафик, использующий формат 4к. Для этих **10% для расчета будут взяты 20 Мбит/c**. Остальные же **90% будут использовать 3 Мбит/c** с погрешностью на просмотр 360р при плохом интернет соединении. Дневная аудитория 2.5 млн и каджый проводит около 17 минут за просмотром контента. В результате расчета будет 43 млн минут в день. 
Формула для 10%: (4.300.000*60)*20 = 5 160 000 000 Мбит за весь день или **0,645 как суммарный сетевой трафик на 4к видеоматериал**.
Формула для 90%: (38.700.000*60)*3 = 6 966 000 000 Мбит за весь день или **0,871 как суммарный сетевой трафик на 1080р и 360р видеоматериал**.

Пиковые нагрузки на сервис ориентировочно будут по вечерам буднечных дней или будут на выходных (возможны стихийные изменения как, например, финал ЛЧ по футболу или релиз новой серии популярного сериала, но под такие случаи выделяется дополнительное железо на некоторое время). Это время, когда большинство людей заканчивают работу и начинают отдыхать. Люди могут иметь привычку использовать интернет в вечернее время для развлечения. В моменты пиковой нагрузки возрастать среднее значение сетевого трафика будет **примерно втрое** из-за вышеперечисленного паттерна. 
Для 10% таким образом получается **60 Гбит/с** как среднее значение (5160000/(24*60*60)=60 Гбит/c), а пиковое значение является средним, умноженным на 3, то есть **180 Гбит/с**.
Для 90% таким образом получается **80 Гбит/с** как среднее значение (6966000/(24*60*60)=80 Гбит/c), а пиковое значение является средним, умноженным на 3, то есть **240 Гбит/с**.
Остальные же три минуты в сервисе выполняются оставшиеся действия из мвп.


## Сетевой трафик 10% - обычный (78 Гбит/с)
| Действие  | Скорость трафика |
| ------------- | ------------- |
| Просмотр видеоматериала  | 60 Гбит/с |
| Регистрация и авторизация  | 3 Гбит/c | 
| Поиск фильма  | 8 Гбит/c | 
| Оставление комментария | 5 Гбит/c |
| Платная подписка  | 1 Гбит/c |
| Оценка видеоматериала | 1 Гбит/c|

## Сетевой трафик 10% - пиковый  (235 Гбит/с)
| Действие  | Скорость трафика |
| ------------- | ------------- |
| Просмотр видеоматериала  | 180 Гбит/с |
| Регистрация и авторизация  | 10 Гбит/c | 
| Поиск фильма  | 24 Гбит/c | 
| Оставление комментария | 15 Гбит/c |
| Платная подписка  | 3 Гбит/c |
| Оценка видеоматериала | 3 Гбит/c |


## Сетевой трафик 90% - обычный (98 Гбит/с)
| Действие  | Скорость трафика |
| ------------- | ------------- |
| Просмотр видеоматериала  | 80 Гбит/с |
| Регистрация и авторизация  | 3 Гбит/c | 
| Поиск фильма  | 8 Гбит/c | 
| Оставление комментария | 5 Гбит/c |
| Платная подписка  | 1 Гбит/c |
| Оценка видеоматериала | 1 Гбит/c|

## Сетевой трафик 90% - пиковый  (298 Гбит/с)
| Действие  | Скорость трафика |
| ------------- | ------------- |
| Просмотр видеоматериала  | 240 Гбит/с |
| Регистрация и авторизация  | 10 Гбит/c | 
| Поиск фильма  | 24 Гбит/c | 
| Оставление комментария | 15 Гбит/c |
| Платная подписка  | 3 Гбит/c |
| Оценка видеоматериала | 3 Гбит/c |

# Глобальная балансировка нагрузки
## Функциональное разбиение по доменам
Для примера доменное имя моего сервиса будет **FilmHub.ru**.
Сервис будет работать на домеенных зонах Казахстана и Беларуси: 
* **FilmHub.kz**
* **FilmHub.by**

Все версии, которые будут расмотренны далее, будут иметь аналоги и в доменных зонах остальных двух стран.
Тогда для мобильных пользователей, которые составляют около 50% от общего числа пользователей, будет **m.FilmHub.ru**, который оптимизирован для работы с мобильными устройствами. Домен **passport.FilmHub.ru** выполняет аутентификацию пользователей. А также **api.Film.ru** для интеграции с сервисами оплаты или рекламы. 

## Обоснования расположения ДЦ
Дата центры обязательно распологаются в столицах: Москва, Астана, Минск, как наибольшее скокпление ЦА. Ввиду огромной территории РФ и наличия большей части аудитории именно оттуда, то стоит расположить так же ДЦ по всей России в крупных городах, таких как: Санкт-Петербург, Краснодар, Казань, Екатеринбург, Новосибирск, Красноярск, Якутск, Хабаровск и Магадан и Новый Уренгой. Эти города наиболее лучшим образом покрывают всю территорию РФ. Еще добавим Алматы из Казахстана для более качественного покрытия Казахстана.
### Рисунок 2 (схема распределения ДЦ)

![image](https://github.com/user-attachments/assets/852b3e4d-a198-41fb-8a8b-de87bad419b9)

Ссылка на Яндекс Карту: https://yandex.ru/maps/?um=constructor%3A503b82edec1e14fae8d2530b4f6322524f3c2279ef57a085767b4b01a5968f02&source=constructorLink

## Расчет распределения запросов из секции "Расчет нагрузки" по типам запросов по датацентрам
Каждый ДЦ хранит полный объем видеоматериала, доступного на сервисе, поэтому запрос на просмотр или поиск фильма отправляется на ближайший ДЦ. Однако регистрация и авторизация, а также запрос на оформление платной подписки пользователя доступны только в Москве, Питере, Минске, Астане и Красноярске (рисунок 3). Так что соседние ДЦ проксируют запросы на авторизацию, регистрацию и оформление платной подписки на ближайший ДЦ с менее загруженным сервером авторизации (Например: Краснодар - Минск, Новый Уренгой - Питер, Магадан - Красноярск). Для согласованности данных во всех ДЦ запрос на оставление комментария и на оценку видеоматериала возможен через ДЦ Москвы, Питера, Якутска, Казани и Новосибирска (рисунок 4). Все запросы проксируются на ближайший наименее загруженный ДЦ (Минск - Питер, Новый Уренгой - Якутск).

### Рисунок 3  (красным выделены ДЦ с возможностью запросов на регистрацию, авторизацию и оформление платной подписки)
![image](https://github.com/user-attachments/assets/e1551d8b-e77f-4eab-b1b2-840680e3880d)


### Рисунок 4 (красным выделены ДЦ с возможностью запросов на оставление комментария и оценки)

![image](https://github.com/user-attachments/assets/ef59fe59-4a03-42a6-a1af-aa7b5f50d9a9)


## Схема DNS балансировки
**Latency-based DNS (GeoDNS)** позволит выдавать адрес ближайшего ДЦ с минимальным RTT, на что и рассчитано расположение наших ДЦ. 

## Механизм регулировки трафика между ДЦ
Если ближайший сервер перегружен, то запрос отправиться на соседний, например человек из города Чита направляет запрос на ДЦ Красноярска, однако тот перегружен. В этом случае запрос пользователя будет направлен на сервер из Якутска. Этот пример иллюстрирует наглядно механизм регулировки трафика между ДЦ в критических случаях, который может продолжаться и более чем в две итерации.


# Источники 

[1] https://web.archive.org/web/20181201005421/https://www.alexa.com/siteinfo/kinopoisk.ru 

[2]  https://web.archive.org/web/20231129184042/https://radar.yandex.ru/yandex?month=2022-05

[3] https://www.rbc.ru/technology_and_media/16/11/2023/65548b529a7947815e93d67b

[4] https://www.buro247.ru/news/culture/14-dec-2023-kinopoisk-results-of-the-year.html

[5] https://www.kinopoisk.ru/votes/

[6] https://www.kinopoisk.ru/reviews/
